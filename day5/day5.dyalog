p q←{⍵⊆⍨×≢¨⍵}⊃⎕NGET'input'1
p←↑⍎¨⊃¨'(\d+)\|(\d+)'⎕S'\1 \2'¨p
q←{⍎','⎕R' '⊢⍵}¨q

t←p[;1] {⍺ ⍵}⌸ p[;2]
f ← {~⍺∊⍵[;1]:⍬⋄↑⍵[⍵[;1]⍳⍺;2]}
c ← { ⍺←1 ⋄ 0=⍺:0 ⋄ 0=≢⍵:1 ⋄ ((¯1+≢⍵)=≢((⊃⍵) f t)∩(1↓⍵))∇ 1↓⍵ }
+/{⍵[(⌈0.5×≢⍵)]}¨(q/⍨{c ⍵}¨q) ⍝ part 1

sort←{ x←⍵ ⋄ y←{1+≢(x[⍵]lookup t)∩x}¨⍳≢x ⋄ ⌽⍵[⍋y] }
+/{⍵[(⌈0.5×≢⍵)]} ¨ sort ¨ (q/⍨~{c ⍵}¨q) ⍝ part 2